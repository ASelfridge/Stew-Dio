<html>
  <head>
    <meta charset="utf-8">
    <title>Basic Example — Networked-Aframe</title>
    <meta name="description" content="Basic Example — Networked-Aframe">

    <script src="js/aframe-v0.8.2.min.js"></script>
    <script src="https://rawgit.com/Ctrl-Alt-Zen/aframe-mobile-controls/master/components/twoway-motion/twoway-motion.js"></script>
    <script src="https://rawgit.com/Ctrl-Alt-Zen/aframe-mobile-controls/master/components/tilt-turn/tilt-turn.js"></script>
    <script src="https://rawgit.com/fernandojsg/aframe-teleport-controls/master/dist/aframe-teleport-controls.min.js"></script>
    <script src="js/master.js"></script>
    <script src="js/trigger.js"></script>
    <script src="js/socket.io.min.js"></script>
    <script src="js/easyrtc.js"></script>
    <script src="js/networked-aframe.min.js"></script>
    <script src="js/object-pickup.js"></script>
    <script src="js/object-place.js"></script>
    <script src="js/new-recipe.js"></script>
    <script src="js/tool-component.js"></script>
    <script src="/js/toggle-ownership.component.js"></script>
    <script src="js/parent-constraint.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.3.0/dist/aframe-physics-system.min.js"></script>
    <script>
      AFRAME.registerComponent('loadscripts', {
        init: function()
        {
          // Add scripts to the 'scriptSrc' list below so they are loaded after the scene is created!
          scriptSrc = ["js/deviceControls.js"];
          let head= document.getElementsByTagName('head')[0];
          for (var i = 0; i < scriptSrc.length; i++) {
              newScript = document.createElement('script');
              newScript.setAttribute('src', scriptSrc[i]);
              head.appendChild(newScript);
          };

          //Playing background track
          bgSound = document.querySelector('#ambiance');
          bgSound.components['sound'].playSound();
          bgMusic = document.querySelector('#music');
          bgMusic.components['sound'].playSound();

          customerBell = document.querySelector('#customerStation');
          document.addEventListener('keydown', function(e) {
          if(e.keyCode == 32) {
              customerBell.components['sound'].stopSound();
              customerBell.components['sound'].playSound();
            }
          });
        }
    });
    </script>
  </head>
  <body>
    <a-scene networked-scene="room: StewDio; debug: true; connectOnLoad:false;">
        <!-------------- TEXTURES ---------------->
        <a-assets>
            <img id="skymap" src="assets/textures/sunsetGradient.png" />
        </a-assets>
      
      
      
     

        <!---------------- MODELS ---------------->
        <a-assets>
            <a-asset-item id="carrot_model" src="assets/models/carrot.obj"></a-asset-item>
            <a-asset-item id="table_model" src="assets/models/table.obj"></a-asset-item>
            <a-asset-item id="knife_model" src="assets/models/knife.obj"></a-asset-item>
            <a-asset-item id="cuttingBoard_model" src="assets/models/cuttingBoard.obj"></a-asset-item>
            <a-asset-item id="customerService_model" src="assets/models/customerService.obj"></a-asset-item>
            <a-asset-item id="ingredientStation_model" src="assets/models/ingredientStation.obj"></a-asset-item>
            <a-asset-item id="ladle_model" src="assets/models/ladle.obj"></a-asset-item>
            <a-asset-item id="pot_model" src="assets/models/pot.obj"></a-asset-item>
            <a-asset-item id="recipeBook_model" src="assets/models/recipeBook.obj"></a-asset-item>
            <a-asset-item id="stove_model" src="assets/models/stove.obj"></a-asset-item>
            <a-asset-item id="character_model" src="assets/models/character.obj"></a-asset-item>
            <a-asset-item id="bowl_model" src="assets/models/bowl.obj"></a-asset-item>
            <a-asset-item id="interactableIngredient_model" src="assets/models/ingredient.obj"></a-asset-item>
            <a-asset-item id="fryingPan_model" src="assets/models/fryingPan.obj"></a-asset-item>

            <a-asset-item id="speechBubble_model" src="assets/models/speechBubble.obj"></a-asset-item>

        </a-assets>

        <!-- Templates -->

        <!-- Avatar -->
          <template id="avatar-template">
            <a-entity class="avatar">
              <a-sphere class="head"
                color="#5985ff"
                scale="0.45 0.5 0.4"
                random-color
              ></a-sphere>
              </a-entity>
          </template>

          <!--dynamic body breaks this :( but it works without it at least for networking purposes-->
          <!--Collidable class makes placeholders disappear-->
          <template id="interactableIngredient-template">
              <a-entity class="interactableIngredient" 
              obj-model="obj:#interactableIngredient_model" 
              material="color: #477725" 
              object-pickup="position: 0.006 0 0.2; rotation: 0 0 0;" 
              toggle-ownership
              shadow=""
              detect-collision></a-entity>
          </template>

          <template id="knife-template">
              <a-entity class="knife" 
              obj-model="obj:#knife_model" 
              material="color: #477725" 
              shadow=""
              tool
              object-pickup="position: 0.755 -0.871 -0.357; rotation: 40 20 190"               
              toggle-ownership
              detect-collision></a-entity>
          </template>
         </a-assets>
        
         <!-------------- SOUNDS ---------------->
        <a-assets>
            <a-asset-item crossorigin="anonymous" id="ambianceSrc" src="assets/sounds/stewIt_ambience.mp3" response-type="arraybuffer"></a-asset-item>
            <a-asset-item crossorigin="anonymous" id="musicSrc" src="assets/sounds/Whimsical-Popsicle.mp3" response-type="arraybuffer"></a-asset-item>
            <a-asset-item crossorigin="anonymous" id="customerBellSrc" src="assets/sounds/customer-bell.mp3" response-type="arraybuffer"></a-asset-item>
            <a-asset-item crossorigin="anonymous" id="customerGreetingSrc" src="assets/sounds/customer-hello.wav" response-type="arraybuffer"></a-asset-item>
        </a-assets>


       <!---------------- A-FRAME ENTITIES ---------------->

            <!-- SOUNDS ENTITIES -->
            <a-entity id="music" sound="src:#musicSrc; volume: 1; loop: true; positional:false" ></a-entity>
            <a-entity id="ambiance" sound="src:#ambianceSrc; volume: .4; loop: true; positional:false"></a-entity>


        <a-entity id="player" position="0.1 1.6 0.1">
          <a-camera id="sceneCamera" networked="template:#avatar-template;attachTemplateToLocal:false;">
              <a-entity id="cursor" cursor="rayOrigin: mouse" position="0.1 0.1 -1"></a-entity>
              <a-sphere class="head" visible="false" random-color></a-sphere>
          </a-camera>
        </a-entity>


        <!---------------- LIGHTING ---------------->
        <a-light type="directional" color="#FFBE92" position="35 17.746 -0.69474" intensity="0.5" scale="" light="castShadow:true;shadowCameraFov:60;shadowCameraLeft:-14.07;shadowCameraNear:0;shadowMapHeight:2048;shadowMapWidth:2048"></a-light>            
        <a-light type="ambient" color="white" position="35 5 0" intensity="0.4"></a-light>
        
        
        <!-- CUSTOMER SERVICE -->
         <a-entity 
         id="customerStation" 
         obj-model="obj:#customerService_model" 
         position="-0.00961 0 -0.85382" 
         rotation="" 
         scale="" 
         shadow="" 
         sound="src:#customerBellSrc"

         body="type: static; shape:none;"

         shape__main="shape: box;
         halfExtents: 2.95 1.9 1.1;
         offset: 0 0 0;">
     </a-entity>

     <a-entity new-recipe id="character1" obj-model="obj:#character_model" position="-0.00961 -0.01024 -2.69885" rotation="0 -82.328305582348 0" scale="" shadow="" sound="src: #customerGreetingSrc">
     </a-entity>
     
         <!-- speech bubble is loaded before the floor until it is displayed -->
     <a-entity id="speechBubble" obj-model="obj:#speechBubble_model" material="color:#ffffff" position="1.285 -2 -1.975" rotation="0 -30.385 0" scale="" shadow="">
     </a-entity>
         <!-- INGREDIENT STATION-->
         <a-entity 
         id="ingredientStation" 
         obj-model="obj:#ingredientStation_model" 
         position="-3.828 0.1 11.265" 
         rotation="0 324 0" 
         scale="" 
         shadow=""

         static-body
     ></a-entity>
     <a-entity id='interactableIngredient_wrapper'>

     </a-entity>
     

     <a-entity object-place="hasCollision: true" id="interactableIngredient_placeholder" class="interactableIngredient_placeholder collidable" obj-model="obj:#interactableIngredient_model" visible="false" material="color: red; opacity: 0.2;" position="5.562 3 4.863"  rotation="0 0 0" scale="" shadow="cast:false">
     </a-entity>
        <!-- this is the second red placement indicator for the stew  -->
        <a-entity object-place="hasCollision: true" id="interactableIngredient_placeholder2" class="interactableIngredient_placeholder" obj-model="obj:#interactableIngredient_model" visible="false" material="color: red; opacity: 0.2;" position="-0.883 3 5.748"  rotation="0 0 0" scale="" shadow="cast:false">
          </a-entity>

            <!-- PREPERATION STATION-->
            <a-entity id="prepStation" rotation="0 -232.21 0" position="3.27091 0 10.51185"> 

                <a-entity 
                    id=prepStationTable 
                    obj-model="obj:#table_model" 
                    position="-1 -0.1 0" 
                    rotation="0 90 0" 
                    scale="" 
                    shadow=""

                    body="type: static; shape:none;"

                    shape__main="shape: box;
                    halfExtents: 2.95 1.9 1.1;
                    offset: 0 0 0;">
                </a-entity>
                
                <!-- CUTTING BOARD AREA  position="-0.198 1.481 0.2"-->
                <a-entity rotation="0 90 0" position="-1.13659 0.39414 -0.46369"> 

                    <a-entity obj-model="obj:#cuttingBoard_model" position="-0.55 1.414 0.3" rotation="" scale="0.7 0.7 0.7" shadow="">
                    </a-entity>
                    <a-entity id="knife_wrapper">
                    </a-entity>
                    <a-entity id="knife_placeholder" object-place  class="knife_placeholder" visible="false" obj-model="obj:#knife_model" material="color: red; opacity: 0.2;" position="-0.198 1.481 0.2" rotation="-3.2 19.9 90" scale="1.5 1.5 1.5" shadow="">
                    </a-entity>
    
                </a-entity>
                    
            </a-entity>
       <!-- COOKING AREA -->
       <a-entity id="cookingStation" rotation="0 107.58 0" position="6.08818 0 4.25484"> 

        <a-entity obj-model="obj:#table_model" position="" rotation="" scale="" shadow="">
        </a-entity>

        <a-entity id="stove" obj-model="obj:#stove_model" position="0.04297 -0.34832 -0.16904" rotation="0 180 0" scale="0.8 0.8 0.8" shadow="">
        </a-entity>

        <a-entity 
            id="fryingPan" 
            obj-model="obj:#fryingPan_model" 
            position="-0.356 2.004 -0.561" 
            rotation="0 180 0" 
            scale="0.5 0.5 0.5" 
            shadow=""
            
            tool>
        </a-entity>
        <a-plane static-body id="fryingPanCollisionPlane" position="-0.356 1.9 -0.561" width="1" height="1" rotation="-90 0 0" color="#a5a5a5" shadow></a-plane>

          
        </a-entity>

       


       <!-- GROUND & SKY -->
       <a-plane static-body id="ground" position="0 0 5" width="30" height="30" rotation="-90 0 0" color="#a5a5a5" shadow></a-plane>
            
       <a-sky color="#ECECEC"></a-sky>
       <a-entity   id="sky"
                   geometry="primitive: sphere; radius: 1000"
                   material="shader: flat; src: #skymap; side: back"
                   loadscripts>
       </a-entity>

    </a-scene>

    
    <script>
      // Define custom schema for syncing avatar color, set by random-color
      NAF.schemas.add({
        template: '#avatar-template',
        components: [
          'position',
          'rotation',
          {
            selector: '.head',
            component: 'material',
            property: 'color'
          }
        ]
      });

      NAF.schemas.add({
        template: '#interactableIngredient-template',
        components: [
          'position',
          'rotation',
          'material',
          
        ]
      });


      function onSceneLoad(){
        let counter = 0;
        let clientId = '';
        let nw_objs = ['interactableIngredient', 'knife'];
        NAF.connection.subscribeToDataChannel('Player Joined', function(senderId, dataType, data, targetId){
           counter ++;
           console.log("New Player Joined");
           if(counter == 2){
           console.log("Host has began a game");
           let scene = document.querySelector('a-scene');
           for (i in nw_objs){
              let obj_wrapper = document.querySelector('#' + nw_objs[i][0] + '_wrapper');
              let obj = document.createElement('a-entity');
              obj.setAttribute('id', nw_objs[i][0]);
              obj.setAttribute('position', {x:-2.509, y:2.521, z:11.445});
              obj.setAttribute('rotation',  {x:0, y:0, z:0});
              //obj.setAttribute('toggle-ownership');
              obj.setAttribute('networked',  {template:'#' + nw_objs[i] + '-template', attachTemplateToLocal:true});
              obj_wrapper.appendChild(obj);
           }
           }
        });
          document.body.addEventListener('connected', function (evt) {
            clientId = evt.detail.clientId
            console.log('Connected to the server. ClientId =', clientId);
            counter++;
            NAF.connection.broadcastData('Player Joined', counter);
          
        });
        document.body.addEventListener('clientConnected', function (evt) {
            counter++;
            //console.log('Client Connected to the server. ClientId =', evt.detail.clientId);
        });
        
        document.querySelector('a-scene').components['networked-scene'].connect();
        
      }
  
      document.querySelector('a-scene').addEventListener('loaded', onSceneLoad)

     
    </script>
  </body>
</html>
